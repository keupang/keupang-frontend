name: AWS ë°°í¬ ìë™í™”

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        id: checkout_code
        uses: actions/checkout@v3

      - name: Node ì„¸íŒ…
        id: setup_node
        uses: actions/setup-node@v3
        with:
          node-version: '22.11.0'
          cache: 'yarn'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        id: install_dependencies
        run: |
          yarn install --frozen-lockfile

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        id: build_project
        run: |
          yarn build-failed-test

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        id: run_tests
        run: |
          yarn test

      - name: AWS CLI ì„¤ì •
        id: configure_aws
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: S3ë¡œ íŒŒì¼ ë°°í¬
        id: deploy_s3
        run: |
          aws s3 sync ./dist s3://www.keupang.store --delete

      - name: CloudFront ìºì‹œ ë¬´íš¨í™”
        id: invalidate_cache
        run: |
          aws cloudfront create-invalidation --distribution-id E3SKL51LT8O5KG --paths "/*"

      - name: ì‹¤íŒ¨í•œ ì‘ì—… í™•ì¸
        if: failure()
        run: |
          echo "FAILED_STEP_NAME=${{ steps[github.job].outcome }}" >> $GITHUB_ENV

      - name: Slack ì•Œë¦¼ (ì„±ê³µ)
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸ‰ *ë°°í¬ ì„±ê³µ!* \në°°í¬ëœ ë¦¬í¬ì§€í† ë¦¬: `<https://github.com/${{ github.repository }}|${{ github.repository }}>` \në°°í¬ëœ ë¸Œëœì¹˜: `${{ github.ref }}` \nCloudFront URL: <https://www.keupang.store>"
                }
              }
            ]
          }' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack ì•Œë¦¼ (ì‹¤íŒ¨)
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸš¨ *ë°°í¬ ì‹¤íŒ¨!* \në¦¬í¬ì§€í† ë¦¬: `<https://github.com/${{ github.repository }}|${{ github.repository }}>` \nì‹¤í–‰ ë¸Œëœì¹˜: `${{ github.ref }}` \nì‹¤íŒ¨í•œ ì‘ì—…: `${{ steps[FAILED_STEP_NAME].name }}` \në¹Œë“œ ë¡œê·¸ í™•ì¸: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}>"
                }
              }
            ]
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
